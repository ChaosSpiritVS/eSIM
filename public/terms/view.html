<!doctype html>
<html lang="zh-Hans">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>政策与条款</title>
    <link rel="stylesheet" href="/public/help/styles.css">
    <script src="terms.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  </head>
  <body>
    <div class="screen">
      <div class="content" id="content"></div>
    </div>
    <script>
      if (typeof detectLang !== 'function') {
        function detectLang() {
          try { const qp = new URL(window.location.href).searchParams.get('lang'); return qp === 'zh' ? 'zh' : 'en'; } catch(_) { return 'en'; }
        }
      }
      if (typeof detectLocale !== 'function') {
        function detectLocale() {
          try {
            const url = new URL(window.location.href);
            const cand = (url.searchParams.get('locale') || url.searchParams.get('lang') || (navigator.language || 'en')).toLowerCase();
            if (cand.startsWith('zh')) { if (cand.includes('hant') || cand.includes('tw') || cand.includes('hk')) return 'zh-Hant'; return 'zh-Hans'; }
            if (cand.startsWith('en')) return 'en'; if (cand.startsWith('ja')) return 'ja'; if (cand.startsWith('ko')) return 'ko'; if (cand.startsWith('th')) return 'th'; if (cand.startsWith('id')) return 'id'; if (cand.startsWith('es')) return 'es'; if (cand.startsWith('pt')) return 'pt'; if (cand.startsWith('ms') || cand.startsWith('ml')) return 'ms'; if (cand.startsWith('vi')) return 'vi'; if (cand.startsWith('ar')) return 'ar';
            return 'en';
          } catch(_) { return 'en'; }
        }
      }
      const lang = detectLang();
      const locale = detectLocale();
      document.documentElement.lang = locale;
      const url = new URL(window.location.href);
      const topic = url.searchParams.get('topic') || '';
      const content = document.getElementById('content');
      renderLangToggle(content, lang, topic);
      const card = document.createElement('div'); card.className='card';
      const container = document.createElement('div');
      container.id = 'docx';
      container.style.padding = '8px 4px';
      card.appendChild(container);
      content.appendChild(card);
      const base = getTermsBase();
      const folder = getLangFolder(locale);
      function fetchDoc(p) { const u = encodeURI(p) + (p.includes('?') ? '&' : '?') + 'v=' + Date.now(); return fetch(u, { cache: 'no-store' }).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.arrayBuffer(); }); }
      const first = `${base}/${topic}/${folder}/${topic}.docx`;
      let used = first;
      const useMammoth = !!window.mammoth;
      if (!useMammoth) {
        const msg = lang==='zh' ? '无法读取文档，点击下载查看：' : 'Unable to read document. Download: ';
        const dl = encodeURI(first);
        container.innerHTML = `<div class="helper">${msg}<a class="link" href="${dl}">${topic || 'Document'}</a></div>`;
      } else {
      fetchDoc(first)
        .catch(()=> { used = `${base}/${topic}/zh-Hans/${topic}.docx`; return fetchDoc(used); })
        .then(buffer=> mammoth.convertToHtml({arrayBuffer: buffer}))
        .then(async res=>{
          function hasCJK(s){ return /[\u4e00-\u9fff]/.test(s || ''); }
          let html = (res && res.value ? res.value.trim() : '');
          if (lang==='zh' && (!hasCJK(html))) {
            for (const p of [`${base}/${topic}/zh-Hans/${topic}.docx`, `${base}/${topic}/zh-Hant/${topic}.docx`]) {
              try { const b2 = await fetchDoc(p); const r2 = await mammoth.convertToHtml({arrayBuffer: b2}); const h2 = (r2 && r2.value ? r2.value.trim() : ''); if (hasCJK(h2)) { html = h2; used = p; break; } } catch(_){ }
            }
          }
          if (html) {
            container.innerHTML = html; pruneRedundantTitle(container, topic);
            try { const doc = new DOMParser().parseFromString(html, 'text/html'); const el = doc.querySelector('h1,h2,h3,p'); const titleText = (el && el.textContent ? el.textContent.trim() : topic); document.title = titleText || document.title; } catch(_){}
          } else {
            const msg = lang==='zh' ? '无法读取文档，点击下载查看：' : 'Unable to read document. Download: ';
            const dl = encodeURI(used);
            container.innerHTML = `<div class="helper">${msg}<a class="link" href="${dl}">${topic || 'Document'}</a></div>`;
          }
        })
        .catch(err=>{
          const dl = encodeURI(used);
          const msg = lang==='zh' ? '无法读取文档，点击下载查看：' : 'Unable to read document. Download: ';
          container.innerHTML = `<div class="helper">${msg}<a class="link" href="${dl}">${topic || 'Document'}</a></div>`;
        });
      }
    </script>
  </body>
</html>
