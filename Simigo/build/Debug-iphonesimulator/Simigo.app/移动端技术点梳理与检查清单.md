# 移动端技术点梳理与检查清单

更新时间：2025-11-10

说明：本清单用于系统性梳理移动应用在网络与缓存之外的关键技术点，指导落地与自检。建议按“基础必备 → 高价值增强 → 长期建设”逐步完成。

## 使用方式
- [ ] 逐条评估适用性，标记完成项与后续待办
- [ ] 为关键项添加负责人、截止日期与验证标准
- [ ] 在版本迭代中复查（发布前/大版本后/核心架构调整后）

## 网络状态与离线处理（MVP）
- 目标：快速具备“检测网络变化 → 请求/页面降级”的基础能力
- 范围与策略（MVP）：
  - [ ] 网络监控服务：基于 `NWPathMonitor` 提供 `isOnline`、`isExpensive/isConstrained` 与连接类型
  - [ ] 全局 UI 提示：离线横幅/Toast，不阻塞操作，支持点击重试
  - [ ] 请求层策略：离线 fail-fast；仅 GET 列表允许自动一次重试；POST/支付仅手动重试
  - [ ] 视图层钩子：`RegionsList/CountriesList/BundleDetail` 在线恢复后自动刷新一次（前台且上次失败）
  - [ ] Checkout：离线时禁止支付与分配，提示联网后重试，保留上下文
  - [ ] 日志与告警：`net_state_changed` 事件（路径属性与触发来源），采样节流
  - [ ] QA 验证：断网/弱网/切换 Wi‑Fi 与蜂窝、门户网络（Captive）场景
- 中期增强：
  - [ ] 幂等请求重试队列（自动）、非幂等请求用户确认（半自动）
  - [ ] 旁路缓存与一致性校验（离线读取、恢复后刷新）
  - [ ] 链路判定与资源策略（受限/昂贵网络下关闭重资源操作）
- 长期建设：
  - [ ] 远程配置与特性开关（自动刷新、重试策略动态调整）
  - [ ] 运营提示与 FAQ（离线引导、可见失败收敛）
  - [ ] 指标体系（离线率、恢复成功率、用户可见失败率）

落地点（Simigo 当前计划）：
- [ ] Services/Network：新增 `NetworkMonitor.swift` 暴露发布状态（主线程安全）
- [ ] Utils/RequestCenter：离线 fail-fast 钩子与重试队列（幂等 GET）
- [ ] Navigation 根视图：全局离线横幅组件与交互
- [ ] ViewModels：为 `Regions/Countries/BundleDetail/Checkout` 接入在线恢复刷新策略
- [ ] Logging：统一 `net_state_changed` 与页面重试来源，节流采样

## MVP 必须项（Simigo 当前工程）
- 编译与启动稳定性
  - [ ] 工程无编译错误，关键路径不再出现“type-check 超时”
  - [ ] 应用能启动到 `ContentView` 并进入主流程
  - [ ] 基本导航可达：`RegionsList` → `CountriesList` → `BundleDetail` → `Checkout` → `OrderDetail`
- 加载与取消一致性
  - [ ] `Regions/Countries/BundleDetail` 结果匹配与加载状态守卫已接入，错位回写率为 0
  - [ ] `CheckoutViewModel` 的 `currentAssignRef` 守卫生效，避免并发错位写入
- 网络状态与离线处理（MVP）
  - [ ] `Services/Network/NetworkMonitor.swift` 提供 `isOnline/isExpensive/isConstrained/interfaceType`
  - [ ] 导航根视图显示离线横幅，支持点击重试与关闭；不阻塞操作
  - [ ] `RequestCenter` 离线 fail-fast；GET 幂等接口自动一次重试；POST/支付禁止自动重试
  - [ ] `Regions/Countries/BundleDetail` 在线恢复自动刷新一次（前台且上次失败）
  - [ ] `Checkout` 离线时禁止支付与分配，提示联网后重试，保留上下文
- 错误展示与空态
  - [ ] 列表页空态与错误提示组件统一（文案、重试入口）
  - [ ] 支付失败/分配失败统一提示与重试入口（避免多点触发）
- 基础日志与可观察性
  - [ ] 事件：`net_state_changed`、`load_started/finished/cancelled`、`assign_started/finished/failed`
  - [ ] 采样与脱敏策略启用（用户信息、支付标识不落库）
- 本地化与可访问性基本线
  - [ ] `en` 与 `zh-Hans` 文案完整；动态字体不破版；暗黑模式适配
- 构建与交付基础
  - [ ] Debug/Release 分离；Signing 可用（开发证书即可）
  - [ ] 版本号与构建号策略；基础 Crash 捕获（可后续接第三方）
- QA 验证
  - [ ] 弱网/断网/切换网络、门户网络（Captive）场景
  - [ ] 并发点击与取消行为、在线恢复刷新
  - [ ] 冷/暖启动状态恢复（回到前台后刷新一次）

## 网络检测补充建议（MVP 之外的增强）
- 连接真实性：
  - [ ] `NWPath` 满足但不可达的门户网络（Captive）场景，使用轻量 `HEAD` 探针到可信域名确认连通
  - [ ] 探针节流与超时控制（避免后台耗电）
- 受限/昂贵网络：
  - [ ] `isConstrained/isExpensive` 下关闭重资源操作（大图/视频），延后非紧急刷新
  - [ ] 资源等级划分与降级策略（加载优先级）
- 生命周期钩子：
  - [ ] 前后台切换时重新评估网络状态，前台恢复触发一次轻量刷新（带节流）
- 请求分类与重试：
  - [ ] 幂等 `GET` 支持自动一次重试（固定或指数退避）；非幂等操作仅手动重试
  - [ ] 重试原因与来源写入日志（便于分析）
- UI 与交互：
  - [ ] 离线横幅样式与交互统一（关闭、重试、跳转设置）
  - [ ] 错误页与占位统一组件（空列表、加载失败）
- 指标与日志：
  - [ ] `net_state_changed` 字段：`prev_state`/`new_state`/`interface`/`isConstrained`/`isExpensive`
  - [ ] 离线率、在线恢复成功率、用户可见失败率

实施顺序（MVP）：
1) 建立 `NetworkMonitor` 与根视图离线横幅
2) `RequestCenter` 接入离线 fail-fast 与 GET 一次自动重试
3) ViewModels 接入在线恢复自动刷新；`Checkout` 禁止离线支付
4) 统一错误组件与基础日志事件；补充 QA 场景

## 架构与模块化
- [ ] 明确分层与职责边界（UI、领域、数据、系统适配层）
- [ ] 采用可测试的架构模式（MVVM/Clean Architecture/Redux）
- [ ] 依赖注入与配置隔离（环境、证书、常量、密钥）
- [ ] 特性模块化与按需加载（降低耦合与包体积）
- [ ] 版本化公共组件与协议（API 契约、事件总线、日志）
- [ ] 跨模块错误传播与恢复策略（稳定接口、降级路径）

## 状态与并发
- [ ] 主线程约束与线程安全（UI 更新、Actor/协程/Combine）
- [ ] 任务取消、去重与节流（SingleFlight、Debounce、Back-pressure）
- [ ] 幂等性与重试策略（超时、指数退避、错误分类）
- [ ] 竞争条件与重入防护（键匹配、期望状态守卫）
- [ ] 背压与批处理（列表加载、上报、同步队列）
- [ ] 资源生命周期管理（作用域、自动清理、泄露监控）

## 数据与存储
- [ ] 本地数据库选择与迁移（SQLite/CoreData/Realm，Schema 版本化）
- [ ] 键值与文件存储（UserDefaults、文件系统目录规划）
- [ ] 离线优先与双向同步（队列化提交、冲突解决：LWW/CRDT）
- [ ] 数据保留与清理策略（TTL、LRU、空间配额、敏感数据最小化）
- [ ] 缓存一致性（内存/磁盘/服务端、写入-失效-刷新链路）
- [ ] 数据快照与恢复（导入导出、备份/回滚）

## 鉴权与会话
- [ ] Token 生命周期管理（刷新、过期、撤销、并发刷新防抖）
- [ ] 安全存储（Keychain、Secure Enclave、设备绑定）
- [ ] 登录方式（OIDC/OAuth、Apple/Google 登录、SSO）
- [ ] 会话一致性（跨设备登出、风控与设备信任）
- [ ] 多环境与沙箱（Dev/Staging/Prod、测试账户与数据隔离）
- [ ] 错误与风控提示（需要用户动作与后台自动处理的分层）

## 安全与隐私
- [ ] 传输安全（TLS、证书钉扎、强制 HTTPS、HSTS）
- [ ] 静态与动态加固（敏感数据加密、混淆、反篡改、越狱/Root 检测）
- [ ] 隐私合规（数据最小化、敏感日志脱敏、权限使用解释）
- [ ] 威胁建模与基线（OWASP MASVS、密钥管理、第三方库审计）
- [ ] 安全事件响应（密钥轮换、撤销、远程禁用/Kill Switch）

## 权限与系统能力
- [ ] 权限申请与分层引导（JIT 请求、拒绝后的降级路径）
- [ ] 位置、相机、麦克等能力的前后台策略与退路
- [ ] 媒体库、蓝牙、NFC 等差异化行为与平台限制
- [ ] 权限撤回后的功能降级与用户教育
- [ ] 扩展能力（Share Sheet、App Extensions）与数据桥接

## 通知与消息
- [ ] APNs/FCM 集成与 Token 管理（注册、撤销、更新）
- [ ] 通知分类与交互（深度链接、快捷操作、分组、静默推送）
- [ ] 送达与去重（TTL、批量、用户时段策略）
- [ ] 与应用内消息的整合（实时通道、WebSocket）
- [ ] 数据隐私与展示策略（敏感内容隐藏/摘要）

## 导航与深度链接
- [ ] Universal Links/URL Scheme 与路由映射
- [ ] 冷/暖启动状态恢复（场景还原、参数校验）
- [ ] 多场景/多窗口支持与回栈一致性
- [ ] 分享、扩展与系统入口（Spotlight、Siri Shortcuts）
- [ ] 链接安全与容错（过期、无效、来源校验）

## UI/UX 与可访问性
- [ ] 动态字体与可访问性支持（VoiceOver、对比度、触控目标）
- [ ] 暗黑模式、RTL、本地化文案溢出与断词
- [ ] 骨架屏/占位、空状态与错误引导、离线提示
- [ ] 动画与触感反馈预算（60/120fps、GPU 约束）
- [ ] 列表大数据优化（Diffable、虚拟化、占位）
- [ ] 输入与表单体验（键盘策略、自动填充、校验与错误）

## 性能与资源
- [ ] 启动优化（冷/暖启动、懒加载、按需初始化）
- [ ] 内存与泄露治理（Instruments、缓存预算与上限）
- [ ] 渲染与列表优化（Diffable、图像管线、GPU 约束）
- [ ] 电量与网络开销管理（预取、批量、后台策略）
- [ ] 资源加载策略（图像/字体/脚本、CDN 与切片）

## 国际化与本地化
- [ ] 文案、复数与变体处理，区域格式（时间、货币、数字）
- [ ] 字体与脚本覆盖（中日韩、RTL、Emoji）
- [ ] 时区与夏令时、工作日差异处理
- [ ] 多语言资源加载与回退策略
- [ ] 文化适配与符号/颜色差异

## 可观察性与质量
- [ ] 日志等级与采样策略（隐私脱敏、键追踪、因果链路）
- [ ] 崩溃与卡死监控（Crash/ANR、卡顿与掉帧）
- [ ] 业务与性能度量（转化漏斗、延迟、失败率）
- [ ] 远程配置、特性开关与 Kill Switch
- [ ] 运行时告警与自愈（重试/降级/旁路缓存）

## 测试与质量保障
- [ ] 单元/集成/UI/Snapshot 测试矩阵
- [ ] 合同测试与 API Mock（录像回放、沙箱账号）
- [ ] 性能与电量测试、弱网/断网模拟
- [ ] Flaky 测试治理与 CI 质量门禁
- [ ] 数据驱动测试与覆盖率监控

## 构建与交付
- [ ] 可重现构建与签名（证书、权限、描述文件管理）
- [ ] 多环境配置与秘密管理（Dev/Staging/Prod）
- [ ] CI/CD 自动化（Fastlane、TestFlight/Play 管线、灰度与回滚）
- [ ] 包体积治理（资源切片、图像/二进制压缩、符号裁剪）
- [ ] 变更日志与版本策略（语义化版本、兼容性说明）

## 商店合规与法律
- [ ] 上架规范与审核要点（用户生成内容、订阅/IAP 合规）
- [ ] 隐私政策与同意（GDPR/CCPA、数据删除/导出权利）
- [ ] 年龄与地域合规（COPPA/当地法规）
- [ ] 第三方许可与归属（开源依赖合规）
- [ ] 设备证明与风控（DeviceCheck/SafetyNet）

## 运营与增长
- [ ] Onboarding 与渐进呈现（新手引导、教育）
- [ ] A/B 实验与分层发布（特性开关、流量分配）
- [ ] 再唤醒机制（通知、Inbox、应用内提示）
- [ ] 客服支持与反馈闭环（日志导出、诊断数据）
- [ ] 事件漏斗与用户分群（留存、转化、活跃）

## 生态扩展
- [ ] 小组件、Live Activities/Dynamic Island、App Clips
- [ ] Spotlight 索引、Siri Shortcuts/Intents
- [ ] Watch/CarPlay 配套与适配
- [ ] 行业集成（支付、地图、身份、分享）

## 离线与同步（补充）
- [ ] 背景刷新与静默推送协同（队列与批量）
- [ ] 冲突策略（服务器权威、本地优先、合并策略）
- [ ] 失败重试与告警（用户可见与后台自动级别）
- [ ] 灾备与数据恢复（快照、事务、校验）

## 优先级建议
- 基础必备：架构与模块化、鉴权与会话、安全与隐私、日志/崩溃监控、CI/CD、测试矩阵
- 高价值增强：可访问性、性能预算、深度链接与状态恢复、远程配置与特性开关、离线与同步
- 长期建设：威胁建模与合规治理、跨平台策略与生态扩展、增长与运营分析

## 项目备注（当前 Simigo）
- 已在多个 ViewModel 接入结果匹配与取消守卫，防止错位回写（Regions/Countries/BundleDetail/Checkout）。
- 仓库层针对类型推断开销大的表达式已拆分为更易检查的结构，提升编译稳定性（UpstreamOrderRepository）。
- 建议开启细粒度日志开关并进行弱网场景的回归测试，验证并发与取消策略。
- 如需将本清单映射到具体代码位置与短中长期路线图，可进一步补充“负责人/截止时间/完成标准”。