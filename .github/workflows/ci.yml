name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  backend:
    name: Backend Unit & Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('server/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r server/requirements.txt

      - name: Initialize DB schema
        run: |
          python - << 'PY'
          from server.app.db import init_db
          init_db()
          print('DB initialized')
          PY

      - name: Run unit tests
        env:
          ENABLE_TEST_ENDPOINTS: '1'
        run: |
          set -o pipefail
          python -m unittest discover -v server/tests | tee backend-tests.log


      - name: Upload backend test log
        uses: actions/upload-artifact@v4
        with:
          name: backend-tests-log
          path: backend-tests.log


  ios:
    name: iOS Tests & Coverage
    runs-on: macos-14
    env:
      SIM_UDID: 85C4C6E0-46A3-44A7-8035-7EDED91DDE46
      IOS_RUNTIME: '18.2'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Show Xcode version
        run: xcodebuild -version
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Get Xcode version (unit)
        id: xcode
        run: |
          echo "version=$(xcodebuild -version | head -n 1 | sed 's/Xcode //')" >> $GITHUB_OUTPUT
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Cache DerivedData (unit)
        uses: actions/cache@v4
        with:
          path: .derivedData-unit
          key: ${{ runner.os }}-xcode-${{ steps.xcode.outputs.version }}-unit-${{ hashFiles('Simigo/Simigo.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-xcode-${{ steps.xcode.outputs.version }}-unit-
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Select Simulator
        id: sim
        run: |
          xcrun simctl list devices --json > devices.json
          cat > select_sim.py << 'PY'
          import os, json
          pref = os.getenv('SIM_UDID')
          desired_os = os.getenv('IOS_RUNTIME', '18.2')
          with open('devices.json') as f:
              d = json.load(f)
          devs = d.get('devices', {})
          chosen_udid = None
          chosen_name = None
          if pref:
              for runtime in devs:
                  for dev in devs[runtime]:
                      if dev.get('udid') == pref:
                          chosen_udid = dev.get('udid')
                          chosen_name = dev.get('name')
                          break
                  if chosen_udid:
                      break
          if not chosen_udid:
              cands = []
              for runtime in devs:
                  if ('iOS' in runtime) and (desired_os in runtime):
                      for dev in devs[runtime]:
                          name = dev.get('name','')
                          state = dev.get('state','')
                          udid = dev.get('udid','')
                          avail = dev.get('isAvailable', True)
                          if 'iPhone' in name and udid and avail:
                              pri = 0
                              if 'iPhone SE (3rd generation)' in name:
                                  pri = 100
                              elif 'iPhone 16 Pro Max' in name:
                                  pri = 90
                              else:
                                  pri = 80
                              if state in ('Booted','Shutdown'):
                                  pri += 2
                              cands.append((pri, name, udid))
              if cands:
                  cands.sort(reverse=True)
                  chosen_udid = cands[0][2]
                  chosen_name = cands[0][1]
          if not chosen_udid:
              for runtime in devs:
                  for dev in devs[runtime]:
                      name = dev.get('name','')
                      udid = dev.get('udid','')
                      if 'iPhone' in name and udid:
                          chosen_udid = udid
                          chosen_name = name
                          break
                  if chosen_udid:
                      break
          out = os.environ.get('GITHUB_OUTPUT')
          with open(out, 'a') as fo:
              fo.write(f"udid={chosen_udid or ''}\n")
              fo.write(f"name={chosen_name or ''}\n")
          print(f"Chosen simulator: {chosen_name or 'N/A'} ({chosen_udid or 'N/A'})")
          PY
          python3 select_sim.py
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Build for testing (unit)
        env:
          DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer
        run: |
          DERIVED="$PWD/.derivedData-unit"
          set -o pipefail
          if [ -z "${{ steps.sim.outputs.udid }}" ]; then echo "No simulator UDID found"; exit 1; fi
          xcrun simctl boot "${{ steps.sim.outputs.udid }}" || true
          echo "Using simulator: ${{ steps.sim.outputs.name }} (${{ steps.sim.outputs.udid }})"
          xcodebuild \
            -project Simigo/Simigo.xcodeproj \
            -scheme Simigo \
            -destination "platform=iOS Simulator,OS=18.2,id=${{ steps.sim.outputs.udid }}" \
            -derivedDataPath "$DERIVED" \
            -sdk iphonesimulator \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO ONLY_ACTIVE_ARCH=YES \
            build-for-testing | tee xcodebuild.log
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Test without building (unit)
        env:
          DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer
        run: |
          DERIVED="$PWD/.derivedData-unit"
          set -o pipefail
          xcodebuild \
            -project Simigo/Simigo.xcodeproj \
            -scheme Simigo \
            -destination "platform=iOS Simulator,OS=18.2,id=${{ steps.sim.outputs.udid }}" \
            -derivedDataPath "$DERIVED" \
            -resultBundlePath TestResults.xcresult \
            -sdk iphonesimulator \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO ONLY_ACTIVE_ARCH=YES \
            test-without-building | tee -a xcodebuild.log
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      

      - name: Upload xcresult bundle
        uses: actions/upload-artifact@v4
        with:
          name: ios-xcresult
          path: TestResults.xcresult
        if: ${{ always() && (hashFiles('**/*.pbxproj') != '') }}

      - name: Upload devices json
        uses: actions/upload-artifact@v4
        with:
          name: ios-devices-json
          path: devices.json
        if: ${{ always() && (hashFiles('**/*.pbxproj') != '') }}

      - name: Upload xcodebuild log
        uses: actions/upload-artifact@v4
        with:
          name: ios-xcodebuild-log
          path: xcodebuild.log
        if: ${{ always() && (hashFiles('**/*.pbxproj') != '') }}

      


  ios_integration_ui:
    name: iOS Integration + UI (with backend)
    runs-on: macos-14
    env:
      SIM_UDID: 85C4C6E0-46A3-44A7-8035-7EDED91DDE46
      IOS_RUNTIME: '18.2'
    needs: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Get Xcode version (integration)
        id: xcode
        run: |
          echo "version=$(xcodebuild -version | head -n 1 | sed 's/Xcode //')" >> $GITHUB_OUTPUT
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r server/requirements.txt
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Start backend (fake upstream) on 127.0.0.1:3001
        run: |
          export PROVIDER_FAKE=true
          nohup python -m uvicorn server.app.main:app --host 127.0.0.1 --port 3001 &
          sleep 5
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Select Simulator
        id: sim2
        run: |
          xcrun simctl list devices --json > devices.json
          cat > select_sim2.py << 'PY'
          import os, json
          pref = os.getenv('SIM_UDID')
          desired_os = os.getenv('IOS_RUNTIME', '18.2')
          with open('devices.json') as f:
              d = json.load(f)
          devs = d.get('devices', {})
          chosen_udid = None
          chosen_name = None
          if pref:
              for runtime in devs:
                  for dev in devs[runtime]:
                      if dev.get('udid') == pref:
                          chosen_udid = dev.get('udid')
                          chosen_name = dev.get('name')
                          break
                  if chosen_udid:
                      break
          if not chosen_udid:
              cands = []
              for runtime in devs:
                  if ('iOS' in runtime) and (desired_os in runtime):
                      for dev in devs[runtime]:
                          name = dev.get('name','')
                          state = dev.get('state','')
                          udid = dev.get('udid','')
                          avail = dev.get('isAvailable', True)
                          if 'iPhone' in name and udid and avail:
                              pri = 0
                              if 'iPhone SE (3rd generation)' in name:
                                  pri = 100
                              elif 'iPhone 16 Pro Max' in name:
                                  pri = 90
                              else:
                                  pri = 80
                              if state in ('Booted','Shutdown'):
                                  pri += 2
                              cands.append((pri, name, udid))
              if cands:
                  cands.sort(reverse=True)
                  chosen_udid = cands[0][2]
                  chosen_name = cands[0][1]
          if not chosen_udid:
              for runtime in devs:
                  for dev in devs[runtime]:
                      name = dev.get('name','')
                      udid = dev.get('udid','')
                      if 'iPhone' in name and udid:
                          chosen_udid = udid
                          chosen_name = name
                          break
                  if chosen_udid:
                      break
          out = os.environ.get('GITHUB_OUTPUT')
          with open(out, 'a') as fo:
              fo.write(f"udid={chosen_udid or ''}\n")
              fo.write(f"name={chosen_name or ''}\n")
          print(f"Chosen simulator: {chosen_name or 'N/A'} ({chosen_udid or 'N/A'})")
          PY
          python3 select_sim2.py
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Cache DerivedData (integration)
        uses: actions/cache@v4
        with:
          path: .derivedData-integration
          key: ${{ runner.os }}-xcode-${{ steps.xcode.outputs.version }}-integration-${{ hashFiles('Simigo/Simigo.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-xcode-${{ steps.xcode.outputs.version }}-integration-
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Build for testing (integration)
        env:
          DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer
          SIMIGO_BASE_URL: http://127.0.0.1:3001
        run: |
          DERIVED="$PWD/.derivedData-integration"
          set -o pipefail
          if [ -z "${{ steps.sim2.outputs.udid }}" ]; then echo "No simulator UDID found"; exit 1; fi
          xcrun simctl boot "${{ steps.sim2.outputs.udid }}" || true
          echo "Using simulator: ${{ steps.sim2.outputs.name }} (${{ steps.sim2.outputs.udid }})"
          xcodebuild \
            -project Simigo/Simigo.xcodeproj \
            -scheme Simigo \
            -destination "platform=iOS Simulator,OS=18.2,id=${{ steps.sim2.outputs.udid }}" \
            -derivedDataPath "$DERIVED" \
            -sdk iphonesimulator \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO ONLY_ACTIVE_ARCH=YES \
            build-for-testing | tee xcodebuild-integration.log
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      - name: Test without building (integration)
        env:
          DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer
          SIMIGO_BASE_URL: http://127.0.0.1:3001
        run: |
          DERIVED="$PWD/.derivedData-integration"
          set -o pipefail
          xcodebuild \
            -project Simigo/Simigo.xcodeproj \
            -scheme Simigo \
            -destination "platform=iOS Simulator,OS=18.2,id=${{ steps.sim2.outputs.udid }}" \
            -derivedDataPath "$DERIVED" \
            -resultBundlePath IntegrationResults.xcresult \
            -sdk iphonesimulator \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO ONLY_ACTIVE_ARCH=YES \
            test-without-building | tee -a xcodebuild-integration.log
        if: ${{ hashFiles('**/*.pbxproj') != '' }}

      

      

      - name: Upload xcresult bundle (integration)
        uses: actions/upload-artifact@v4
        with:
          name: ios-integration-xcresult
          path: IntegrationResults.xcresult
        if: ${{ always() && (hashFiles('**/*.pbxproj') != '') }}

      - name: Upload xcodebuild integration log
        uses: actions/upload-artifact@v4
        with:
          name: ios-integration-xcodebuild-log
          path: xcodebuild-integration.log
        if: ${{ always() && (hashFiles('**/*.pbxproj') != '') }}

      
